<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DVS Dashboard</title>
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <header>
    <h1>ðŸ›¡ DVS Security Dashboard</h1>
    <span class="status" id="status">Disconnected</span>
  </header>

  <main>
    <section class="card">
      <h2>Scan Results</h2>
      <div id="results">
        <p>No scan results yet. Run <code>dvs scan</code> in your terminal.</p>
      </div>
    </section>
  </main>

  <footer>
    <p>Developer Vulnerability Scanner â€” v1.0</p>
  </footer>

  <script>
    const MAX_LEN = 4000;

    function safeText(value) {
      if (value === null || value === undefined) return "";
      const str = String(value);
      return str.length > MAX_LEN ? str.slice(0, MAX_LEN) + "â€¦" : str;
    }

    function safePlain(value) {
      return safeText(DOMPurify.sanitize(String(value ?? ""), { ALLOWED_TAGS: [], ALLOWED_ATTR: [] }));
    }

    function clearEl(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    const wsScheme = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsScheme}://${location.host}`);

    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");

    ws.onopen = () => {
      statusEl.textContent = "Connected";
      statusEl.classList.add("ok");
    };

    ws.onclose = () => {
      statusEl.textContent = "Disconnected";
      statusEl.classList.remove("ok");
    };

    ws.onmessage = (event) => {
      try {
        if (typeof event.data !== "string" || event.data.length > 2_000_000) return;
        const data = JSON.parse(event.data);
        if (data.type === "update" && typeof data.results === "object" && data.results !== null) {
          renderResults(data.results);
        }
      } catch (err) {
        console.error("Failed to parse WS message", err);
      }
    };

    function renderResults(results) {
      clearEl(resultsEl);

      for (const [type, vulns] of Object.entries(results)) {
        if (!Array.isArray(vulns)) continue;

        const section = document.createElement("div");
        section.className = "vuln-section";

        const h3 = document.createElement("h3");
        h3.textContent = `${safeText(type.toUpperCase())} (${vulns.length})`;
        section.appendChild(h3);

        if (vulns.length === 0) {
          const p = document.createElement("p");
          p.className = "safe";
          p.textContent = "No vulnerabilities found âœ…";
          section.appendChild(p);
        } else {
          const table = document.createElement("table");
          table.className = "vuln-table";

          const headerRow = document.createElement("tr");
          ["File", "Line", "Pattern", "Recommendation", "Severity", "Confidence", "Snippet", "Sanitized"]
            .forEach(col => {
              const th = document.createElement("th");
              th.textContent = col;
              headerRow.appendChild(th);
            });
          table.appendChild(headerRow);

          vulns.forEach(v => {
            const tr = document.createElement("tr");

            const cells = [
              safeText(v.file),
              safeText(v.line ?? ""),
              safeText(v.pattern),
              safeText(v.recommendation),
              safeText(v.severity),
              safeText(v.confidence),
              safeText(v.snippet ?? ""),
              safeText(v.sanitized ?? "")
            ];

            cells.forEach(val => {
              const td = document.createElement("td");
              td.textContent = val;
              tr.appendChild(td);
            });

            table.appendChild(tr);
          });

          section.appendChild(table);
        }

        resultsEl.appendChild(section);
      }
    }
  </script>
</body>
</html>
